{% extends "base2.html" %}

{% block extra_styles %}
<link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  /* Booking Page Specific Styles */
  .booking-hero {
    background: linear-gradient(135deg, #4361ee 0%, #4cc9f0 100%);
    color: white;
    border-radius: 12px;
    padding: 2.5rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
  }

  .booking-hero::before {
    content: "";
    position: absolute;
    top: -50px;
    right: -50px;
    width: 200px;
    height: 200px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
  }

  .booking-hero::after {
    content: "";
    position: absolute;
    bottom: -80px;
    left: -80px;
    width: 300px;
    height: 300px;
    background: rgba(255,255,255,0.05);
    border-radius: 50%;
  }

  .booking-hero h1 {
    font-weight: 700;
    position: relative;
    z-index: 2;
  }

  .booking-hero p {
    opacity: 0.9;
    position: relative;
    z-index: 2;
  }

  .form-section {
    background-color: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  }

  .section-title {
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
  }

  .section-title i {
    margin-right: 10px;
    font-size: 1.2rem;
  }

  /* Map styling */
  #map {
    height: 300px;
    width: 100%;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  /* Parking spot visualization */
  .parking-lot-visualization {
    overflow: auto;
    max-height: 500px;
    border-radius: 8px;
    background-color: #f8f9fa;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
  }

  .parking-spot-rect {
    stroke-width: 3;
    stroke-opacity: 0.8;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .parking-spot-rect.available {
    fill: var(--success-color);
    stroke: #3a9e3a;
    fill-opacity: 0.5;
  }

  .parking-spot-rect.available:hover {
    fill-opacity: 0.7;
    stroke-width: 4;
  }

  .parking-spot-rect.taken {
    fill: var(--danger-color);
    stroke: #d11a2a;
    fill-opacity: 0.5;
    cursor: not-allowed;
  }

  .parking-spot-rect.selected {
    stroke: var(--primary-color);
    stroke-width: 5;
    stroke-opacity: 1;
    fill-opacity: 0.8;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% { stroke-width: 5; }
    50% { stroke-width: 7; }
    100% { stroke-width: 5; }
  }

  .step-indicator {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    position: relative;
  }

  .step-indicator::before {
    content: "";
    position: absolute;
    top: 15px;
    left: 0;
    right: 0;
    height: 2px;
    background-color: #e9ecef;
    z-index: 1;
  }

  .step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
  }

  .step-number {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .step.active .step-number {
    background-color: var(--primary-color);
    color: white;
  }

  .step.completed .step-number {
    background-color: var(--success-color);
    color: white;
  }

  .step-label {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
  }

  .step.active .step-label {
    color: var(--primary-color);
    font-weight: 600;
  }

  .step.completed .step-label {
    color: var(--success-color);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .booking-hero {
      padding: 1.5rem;
    }

    .parking-lot-visualization {
      max-height: 300px;
    }

    .step-indicator {
      margin-bottom: 1.5rem;
    }

    .step-label {
      font-size: 0.75rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Step Indicator -->
  <div class="step-indicator">
    <div class="step active">
      <div class="step-number">1</div>
      <div class="step-label">Select Location</div>
    </div>
    <div class="step">
      <div class="step-number">2</div>
      <div class="step-label">Choose Time</div>
    </div>
    <div class="step">
      <div class="step-number">3</div>
      <div class="step-label">Pick a Spot</div>
    </div>
    <div class="step">
      <div class="step-number">4</div>
      <div class="step-label">Confirm</div>
    </div>
  </div>

  <!-- Booking Form Card -->
  <div class="form-section">
    <form method="POST" action="{{ url_for('booking.book') }}" id="booking-form">
      {{ form.hidden_tag() }}

      <!-- Location Section -->
      <div class="mb-5">
        <h5 class="section-title"><i class="bi bi-geo-alt-fill"></i>Location Details</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="form-floating">
              <select class="form-select" name="{{ form.city.name }}" id="city-select" onchange="cityChanged(this)" required>
                <option value="" disabled selected>Select a city</option>
                {% for val, label in form.city.choices %}
                  <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
              <label for="city-select">{{ form.city.label }} <span class="text-danger">*</span></label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <select class="form-select" name="{{ form.parkingLot.name }}" id="parking-lot-select" disabled required onchange="parkingLotSelected()">
                <option value="" disabled selected>Please select a city first</option>
              </select>
              <label for="parking-lot-select">{{ form.parkingLot.label }} <span class="text-danger">*</span></label>
            </div>
          </div>
        </div>
      </div>

      <!-- Interactive Map -->
      <div class="mb-5">
        <h5 class="section-title"><i class="bi bi-map"></i>Parking Location Map</h5>
        <div id="map" class="rounded-3"></div>
        <div class="text-muted mt-2"><small>Select a city to view available parking locations</small></div>
      </div>

      <!-- Date & Time Section -->
      <div class="mb-5">
        <h5 class="section-title"><i class="bi bi-calendar-event"></i>Date & Time</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="form-floating">
              <input type="text" class="form-control" id="bookingDate" name="bookingDate" placeholder="Select date" required readonly>
              <label for="bookingDate">Booking Date <span class="text-danger">*</span></label>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-floating">
              <select class="form-select hour-select" name="startHour" required onchange="checkTimeValidity()">
                {% for i in range(7, 24) %}
                  <option value="{{ i }}" {% if i==9 %}selected{% endif %}>{{ "%02d"|format(i) }}:00</option>
                {% endfor %}
              </select>
              <label for="start-time">Start Time <span class="text-danger">*</span></label>
              <input type="hidden" id="start-time" name="startTime">
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-floating">
              <select class="form-select hour-select" name="endHour" required onchange="checkTimeValidity()">
                {% for i in range(7, 24) %}
                  <option value="{{ i }}" {% if i==17 %}selected{% endif %}>{{ "%02d"|format(i) }}:00</option>
                {% endfor %}
              </select>
              <label for="end-time">End Time <span class="text-danger">*</span></label>
              <input type="hidden" id="end-time" name="endTime">
            </div>
          </div>
        </div>
        <div id="time-error" class="text-danger mt-2"></div>
      </div>

      <!-- Parking Spot Visualization -->
      <div id="parking-lot-container" class="mb-4" style="display: none;">
        <h5 class="section-title"><i class="bi bi-p-square-fill"></i>Available Spots</h5>
        <div class="alert alert-info" id="parking-lot-status">
          <i class="bi bi-info-circle-fill me-2"></i>Please select location, date and time to see available spots
        </div>
        <div class="parking-lot-visualization">
          <svg id="parking-svg" viewBox="0 0 720 720" xmlns="http://www.w3.org/2000/svg" class="w-100">
            <image id="parking-image" href="" x="0" y="0" width="100%" height="100%"></image>
            <g id="spot-rects-group"></g>
          </svg>
        </div>
        <input type="hidden" name="spotId" id="selected-spot-id">
      </div>

      <!-- Submit Button -->
      <div class="d-grid mt-4">
        <button type="submit" class="btn btn-primary btn-lg py-3" disabled id="submit-button">
          <i class="bi bi-check-circle-fill me-2"></i>Confirm Booking
        </button>
      </div>
    </form>
  </div>
</div>

<!-- External Resources -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  // Initialize map
  mapboxgl.accessToken = "pk.eyJ1IjoiYWJjZDEyMzQtLSIsImEiOiJjbWNiMGVkdGswODMyMmpzYWVxeXd0OHF2In0.U95wJcVAPpjsoQiRvnXe4Q";
  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/streets-v11",
    center: [33.4299, 35.1264],
    zoom: 7
  });

  // Add navigation controls
  map.addControl(new mapboxgl.NavigationControl());
  map.addControl(new mapboxgl.GeolocateControl({
    positionOptions: {
      enableHighAccuracy: true
    },
    trackUserLocation: true,
    showUserLocation: true
  }));

  // Initialize datepicker
  document.addEventListener('DOMContentLoaded', function() {
    flatpickr("#bookingDate", {
      minDate: "today",
      dateFormat: "Y-m-d",
      onChange: function() {
        checkTimeValidity();
        updateStepIndicator();
      }
    });
  });

  // Update step indicator based on form progress
  function updateStepIndicator() {
    const steps = document.querySelectorAll('.step');
    const citySelected = document.getElementById('city-select').value !== '';
    const lotSelected = document.getElementById('parking-lot-select').value !== '';
    const dateSelected = document.getElementById('bookingDate').value !== '';
    const spotSelected = document.getElementById('selected-spot-id').value !== '';

    steps.forEach((step, index) => {
      step.classList.remove('active', 'completed');

      if (index === 0 && citySelected) {
        step.classList.add('completed');
        steps[1].classList.add('active');
      }

      if (index === 1 && dateSelected) {
        step.classList.add('completed');
        steps[2].classList.add('active');
      }

      if (index === 2 && spotSelected) {
        step.classList.add('completed');
        steps[3].classList.add('active');
      }
    });
  }

  // Check time validity
  function checkTimeValidity() {
    const bookingDate = document.getElementById("bookingDate").value;
    const startHour = parseInt(document.querySelector('[name="startHour"]').value);
    const endHour = parseInt(document.querySelector('[name="endHour"]').value);
    const errorDiv = document.getElementById("time-error");

    let isValid = true;
    let errorMessage = "";

    if (!bookingDate) {
      isValid = false;
      errorMessage = "Please select a booking date.";
    }
    else if (endHour <= startHour) {
      isValid = false;
      errorMessage = "End time must be after start time.";
    }

    errorDiv.textContent = errorMessage;
    document.getElementById("submit-button").disabled = !isValid;

    const parkingLotId = document.getElementById("parking-lot-select").value;
    if (parkingLotId && isValid) {
      fetchSpotStatus();
    }

    updateStepIndicator();
  }

  // City selection handler
  function cityChanged(selectElement) {
    const cityId = selectElement.value;
    const cityName = selectElement.options[selectElement.selectedIndex].text;

    // Reset parking lot selection
    const parkingLotSelect = document.getElementById("parking-lot-select");
    parkingLotSelect.innerHTML = '<option value="" disabled selected>Select a parking lot</option>';
    parkingLotSelect.disabled = true;
    document.getElementById("parking-lot-container").style.display = "none";
    document.getElementById("spot-rects-group").innerHTML = "";
    document.getElementById("selected-spot-id").value = "";
    document.getElementById("submit-button").disabled = true;

    zoomToCity(cityName);
    updateStepIndicator();

    // Fetch parking lots for the selected city
    fetch("/city_selected", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({city: cityId})
    })
    .then(response => response.json())
    .then(data => {
      parkingLotSelect.innerHTML = '<option value="" disabled selected>Select a parking lot</option>';

      data.forEach(lot => {
        const option = document.createElement("option");
        option.value = lot.id;
        option.textContent = lot.name;
        option.dataset.address = lot.address;
        option.dataset.coords = lot.coordinates;
        parkingLotSelect.appendChild(option);
      });

      parkingLotSelect.disabled = false;
    });
  }

  // Parking lot selection handler
  function parkingLotSelected() {
    const select = document.getElementById("parking-lot-select");
    const selectedOption = select.options[select.selectedIndex];

    document.getElementById("parking-lot-container").style.display = "none";
    document.getElementById("selected-spot-id").value = "";
    document.getElementById("submit-button").disabled = true;

    // Update map to show selected parking lot
    if (selectedOption.dataset.coords) {
      const [lng, lat] = selectedOption.dataset.coords.split(',').map(Number);
      map.flyTo({
        center: [lng, lat],
        zoom: 15
      });

      // Add marker
      new mapboxgl.Marker({ color: '#4361ee' })
        .setLngLat([lng, lat])
        .setPopup(new mapboxgl.Popup().setHTML(`
          <h6>${selectedOption.textContent}</h6>
          <p class="mb-1">${selectedOption.dataset.address}</p>
        `))
        .addTo(map);
    }

    checkTimeValidity();
    updateStepIndicator();
  }

  // Fetch spot availability
  function fetchSpotStatus() {
    const parkingLotId = document.getElementById("parking-lot-select").value;
    const bookingDate = document.getElementById("bookingDate").value;
    const startHour = document.querySelector("[name=\"startHour\"]").value.padStart(2, "0");
    const endHour = document.querySelector("[name=\"endHour\"]").value.padStart(2, "0");

    document.getElementById("parking-lot-container").style.display = "block";
    document.getElementById("parking-lot-status").className = "alert alert-info";
    document.getElementById("parking-lot-status").innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Checking availability...';
    document.getElementById("selected-spot-id").value = "";
    document.getElementById("submit-button").disabled = true;

    fetch("/check_spot_availability", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        parkingLotId: parkingLotId,
        bookingDate: bookingDate,
        startTime: `${startHour}:00`,
        endTime: `${endHour}:00`
      })
    })
    .then(response => response.json())
    .then(data => {
      renderParkingSpots(data);
      updateStepIndicator();
    })
    .catch(error => {
      console.error("Error fetching spot status:", error);
      document.getElementById("parking-lot-status").className = "alert alert-danger";
      document.getElementById("parking-lot-status").innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i>Error loading spots. Please try again.';
    });
  }

  // Render parking spots
  function renderParkingSpots(data) {
    const parkingImage = document.getElementById("parking-image");
    const spotRectsGroup = document.getElementById("spot-rects-group");

    parkingImage.setAttribute("href", `/static/images/${data.image_filename}`);
    spotRectsGroup.innerHTML = "";

    let availableCount = 0;
    data.spots.forEach(spot => {
      if (spot.is_available) availableCount++;

      const [x, y, width, height] = spot.svgCoords.split(",");

      const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
      rect.setAttribute("x", x);
      rect.setAttribute("y", y);
      rect.setAttribute("width", width);
      rect.setAttribute("height", height);
      rect.setAttribute("id", `spot-${spot.id}`);
      rect.classList.add("parking-spot-rect");
      rect.classList.toggle("available", spot.is_available);
      rect.classList.toggle("taken", !spot.is_available);

      if (spot.is_available) {
        rect.addEventListener("click", () => {
          const currentSelectedId = document.getElementById("selected-spot-id").value;
          const prevSelected = document.querySelector(".parking-spot-rect.selected");

          if(prevSelected) {
            prevSelected.classList.remove("selected");
          }

          if (currentSelectedId !== String(spot.id)) {
            document.getElementById("selected-spot-id").value = spot.id;
            document.getElementById(`spot-${spot.id}`).classList.add("selected");
            document.getElementById("submit-button").disabled = false;
          } else {
            document.getElementById("selected-spot-id").value = "";
            document.getElementById("submit-button").disabled = true;
          }

          updateStepIndicator();
        });
      }
      spotRectsGroup.appendChild(rect);
    });

    const statusElement = document.getElementById("parking-lot-status");
    if (availableCount > 0) {
      statusElement.className = "alert alert-success";
      statusElement.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>${availableCount} of ${data.spots.length} spots available`;
    } else {
      statusElement.className = "alert alert-warning";
      statusElement.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>No spots available for selected time`;
    }
  }

  // Zoom to city function
  function zoomToCity(cityName) {
    if (!cityName) return;

    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(`${cityName}, Cyprus`)}.json?access_token=${mapboxgl.accessToken}`)
      .then(response => response.json())
      .then(data => {
        if (data.features && data.features.length > 0) {
          map.flyTo({
            center: data.features[0].center,
            zoom: 12
          });
        }
      });
  }

  // Form submission handler
  document.getElementById("booking-form").addEventListener("submit", function(e) {
    const bookingDate = document.getElementById("bookingDate").value;
    const startHour = document.querySelector("[name=\"startHour\"]").value.padStart(2, '0');
    const endHour = document.querySelector("[name=\"endHour\"]").value.padStart(2, '0');

    document.getElementById("start-time").value = `${startHour}:00`;
    document.getElementById("end-time").value = `${endHour}:00`;
  });
</script>
{% endblock %}