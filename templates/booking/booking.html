{% extends 'base1.html' %}

{% block content %}
<div class="container">
    <h1>Book your spot</h1>
    <div class="p-2 row">
        <div class="col-2"></div>
        <div class="col-8">
            <form method="POST">
                <div class="p-2 bg-light border border-primary text-left">
                    {{ form.csrf_token() }}
                    <div class="form-group">
                        {{ form.city.label }}<span class="text-danger">*</span>
                        <select class="form-control" name="{{ form.city.name }}" id="city-select" onchange="cityChanged(this)" required>
                            <option value="" disabled selected hidden>Select a city</option>
                            {% for val, label in form.city.choices %}
                                <option value="{{ label }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        {{ form.parkingLot.label }}<span class="text-danger">*</span>
                        <select class="form-control" name="{{ form.parkingLot.name }}" id="parking-lot-select" disabled required onchange="parkingLotSelected(this)">
                            <option value="" disabled selected hidden>Please select a city first</option>
                        </select>
                    </div>
                </div>
            </form>
            <div id="map" style="height: 500px; width: 100%; margin-top: 20px;"></div>
        </div>
        <div class="col-2"></div>
    </div>
</div>

<!-- Add Mapbox GL JS CSS and JS -->
<link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>

<script>
// Mapbox access token - replace with your own token
mapboxgl.accessToken = 'pk.eyJ1IjoiYWJjZDEyMzQtLSIsImEiOiJjbWNiMGVkdGswODMyMmpzYWVxeXd0OHF2In0.U95wJcVAPpjsoQiRvnXe4Q';

// Initialize the map
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [33.4299, 35.1264], // Cyprus coordinates [lng, lat]
    zoom: 7
});

// Add navigation controls
map.addControl(new mapboxgl.NavigationControl());

// Function to handle city selection change
function cityChanged(selectElement) {
    const cityName = selectElement.value;
    if (!cityName) return;

    // Zoom to the selected city
    zoomToCity(cityName);

    // Fetch parking lots for the selected city
    fetch('/city_selected', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({city: cityName})
    })
    .then(response => response.json())
    .then(data => {
        const parkingSelect = document.getElementById('parking-lot-select');
        parkingSelect.innerHTML = '<option value="" disabled selected hidden>Select a parking lot</option>';

        // Clear previous markers
        clearMarkers();

        data.forEach(lot => {
            const option = document.createElement('option');
            option.value = lot.id;
            option.textContent = lot.name;
            option.dataset.address = lot.address; // Store address for geocoding
            parkingSelect.appendChild(option);
        });

        parkingSelect.disabled = false;
    });
}

// Function to handle parking lot selection
function parkingLotSelected(selectElement) {
    const address = selectElement.options[selectElement.selectedIndex].dataset.address;
    if (!address) return;

    // Geocode the address using Mapbox Geocoding API
    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address + ', Cyprus')}.json?access_token=${mapboxgl.accessToken}`)
        .then(response => response.json())
        .then(data => {
            if (data.features && data.features.length > 0) {
                const coordinates = data.features[0].center;

                // Clear previous markers
                clearMarkers();

                // Add marker for the parking lot
                new mapboxgl.Marker()
                    .setLngLat(coordinates)
                    .setPopup(new mapboxgl.Popup().setHTML(`<h6>${address}</h6>`))
                    .addTo(map);

                // Zoom to the location
                map.flyTo({
                    center: coordinates,
                    zoom: 16
                });
            }
        });
}

// Function to zoom to selected city
function zoomToCity(cityName) {
    if (!cityName) return;

    // Geocode the city using Mapbox Geocoding API
    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(cityName + ', Cyprus')}.json?access_token=${mapboxgl.accessToken}`)
        .then(response => response.json())
        .then(data => {
            if (data.features && data.features.length > 0) {
                const coordinates = data.features[0].center;
                const bbox = data.features[0].bbox;

                if (bbox) {
                    // Fit to bounds if available
                    map.fitBounds([[bbox[0], bbox[1]], [bbox[2], bbox[3]]], {
                        padding: 50
                    });
                } else {
                    // Fly to center if no bounds
                    map.flyTo({
                        center: coordinates,
                        zoom: 12
                    });
                }
            }
        });
}

// Function to clear all markers
function clearMarkers() {
    const markers = document.getElementsByClassName('mapboxgl-marker');
    while (markers.length > 0) {
        markers[0].remove();
    }
}
</script>

{% endblock %}