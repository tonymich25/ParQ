{% extends 'base1.html' %}

{% block content %}
<div class="container">
    <h1>Book your spot</h1>
    <div class="p-2 row">
        <div class="col-2"></div>
        <div class="col-8">
            <form method="POST">
                <div class="p-2 bg-light border border-primary text-left">
                    {{ form.csrf_token() }}
                    <div class="form-group">
                        {{ form.city.label }}<span class="text-danger">*</span>
                        <select class="form-control" name="{{ form.city.name }}" id="city-select" onchange="cityChanged(this)" required>
                            <option value="" disabled selected hidden>Select a city</option>
                            {% for val, label in form.city.choices %}
                                <option value="{{ label }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        {{ form.parkingLot.label }}<span class="text-danger">*</span>
                        <select class="form-control" name="{{ form.parkingLot.name }}" id="parking-lot-select" disabled required onchange="parkingLotSelected(this)">
                            <option value="" disabled selected hidden>Please select a city first</option>
                        </select>
                    </div>
                </div>
            </form>
            <div id="map" style="height: 500px; width: 100%; margin-top: 20px;"></div>
        </div>
        <div class="col-2"></div>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDuGrjd31q_Yad2NrtZh5zy7_mnUBCnSgc&callback=initMap" async defer></script>

<script>
// Global variables for map and geocoder
var map;
var geocoder;
var markers = [];

// Initialize the map
function initMap() {
    geocoder = new google.maps.Geocoder();
    // Set Cyprus as the center
    var cyprus = {lat: 35.1264, lng: 33.4299};
    map = new google.maps.Map(document.getElementById('map'), {
        center: cyprus,
        zoom: 7,
        gestureHandling: 'greedy',
        zoomControl: true,
        mapTypeControl: true,
        scaleControl: true,
        streetViewControl: true,
        rotateControl: true,
        fullscreenControl: true
    });
}

function cityChanged(selectElement) {
    const cityName = selectElement.value;
    if (!cityName) return;

    // Zoom to the selected city
    zoomToCity(cityName);

    // Fetch parking lots for the selected city
    fetch('/city_selected', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({city: cityName})
    })
    .then(response => response.json())
    .then(data => {
        const parkingSelect = document.getElementById('parking-lot-select');
        parkingSelect.innerHTML = '<option value="" disabled selected hidden>Select a parking lot</option>';

        // Clear previous markers
        clearMarkers();

        data.forEach(lot => {
            const option = document.createElement('option');
            option.value = lot.id;
            option.textContent = lot.name;
            option.dataset.address = lot.name; // Store address for geocoding
            parkingSelect.appendChild(option);
        });

        parkingSelect.disabled = false;
    });
}

function parkingLotSelected(selectElement) {
    const address = selectElement.options[selectElement.selectedIndex].dataset.address;
    if (!address) return;

    // Zoom to the exact parking lot location
    geocoder.geocode({'address': address + ', Cyprus'}, function(results, status) {
        if (status === 'OK') {
            // Clear previous markers
            clearMarkers();

            // Add new marker for the parking lot
            const marker = new google.maps.Marker({
                map: map,
                position: results[0].geometry.location,
                title: address
            });
            markers.push(marker);

            // Zoom to a closer level
            map.setCenter(results[0].geometry.location);
            map.setZoom(17); // Very close zoom for precise location

        } else {
            console.warn('Geocode was not successful for the following reason: ' + status);
        }
    });
}

function clearMarkers() {
    markers.forEach(marker => marker.setMap(null));
    markers = [];
}

// Function to zoom to selected city
function zoomToCity(cityName) {
    if (!cityName) return;

    // Find the city on the map
    geocoder.geocode({'address': cityName + ', Cyprus'},
        function(results, status) {
            if (status === 'OK') {
                // Get the location
                var location = results[0].geometry.location;
                var bounds = results[0].geometry.bounds;

                // Move map to the city
                if (bounds) {
                    map.fitBounds(bounds);
                } else {
                    map.setCenter(location);
                    map.setZoom(13);
                }
            } else {
                alert('Could not find the city: ' + cityName);
            }
        });
}
</script>

{% endblock %}