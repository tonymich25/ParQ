{% extends 'base1.html' %}

{% block content %}
<div class="container">
    <h1>Book your spot </h1>
    <div class="p-2 row">
        <div class="col-2"></div>
        <div class="col-8">
            <form method="POST">
                <div class="p-2 bg-light border border-primary text-left">
                    {{ form.csrf_token() }}
                    <div class="form-group">
                        {{ form.city.label }}<span class="text-danger">*</span>
                        <select class="form-control" name="{{ form.city.name }}" onchange="zoomToCity(this.value)" required>
                            <option value="" disabled selected hidden>Select a city</option>
                            {% for val, label in form.city.choices %}
                                <option value="{{ label }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Parking Lot Selection (hidden by default) -->
                    <div class="form-group" id="parking-form" style="{% if not form.city.data %}display:none;{% endif %}">
                        {{ form.parkingLot.label }}
                        <select class="form-control" name="parking_lot">
                            <option value="" disabled selected hidden>Select a parking lot...</option>
                            {% if form.city.data %}
                                {% for lot in get_parking_lots(form.city.data) %}
                                    <option value="{{ lot.id }}">{{ lot.name }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>


                </div>
            </form>
            <div id="map" style="height: 500px; width: 100%; margin-top: 20px;"></div>
        </div>
        <div class="col-2"></div>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDuGrjd31q_Yad2NrtZh5zy7_mnUBCnSgc&callback=initMap" async defer></script>

<script>
// Global variables for map and geocoder
var map;
var geocoder;

// Initialize the map
function initMap() {
    geocoder = new google.maps.Geocoder();
    // Set Cyprus as the center
    var cyprus = {lat: 35.1264, lng: 33.4299};
    map = new google.maps.Map(document.getElementById('map'), {
        center: cyprus,
        zoom: 7,
        gestureHandling: 'greedy',
        zoomControl: true,
        mapTypeControl: true,
        scaleControl: true,
        streetViewControl: true,
        rotateControl: true,
        fullscreenControl: true
    });
}

// Function to zoom to selected city
function zoomToCity(cityName) {
    if (!cityName) return;

    // Send city name to server
    fetch('/city_selected', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({city: cityName})
    });

    // Find the city on the map
    geocoder.geocode({'address': cityName + ', Cyprus'}, function(results, status) {
        if (status === 'OK') {
            // Get the location
            var location = results[0].geometry.location;
            var bounds = results[0].geometry.bounds;

            // Move map to the city
            if (bounds) {
                map.fitBounds(bounds);
            } else {
                map.setCenter(location);
                map.setZoom(13);
            }
        } else {
            alert('Could not find the city: ' + cityName);
        }
    });
}
</script>

{% endblock %}