
{% extends "base1.html" %}

{% block content %}
<div class="container">
    <h1>Book your spot</h1>
    <div class="p-2 row">
        <div class="col-2"></div>
        <div class="col-8">
            <form method="POST" action="{{ url_for("booking.book") }}">
                <div class="p-2 bg-light border border-primary text-left">
                    {{ form.hidden_tag() }}
                    <div class="form-group">
                        {{ form.city.label }}<span class="text-danger">*</span>
                        <select class="form-control" name="{{ form.city.name }}" id="city-select" onchange="cityChanged(this)" required>
                            <option value="" disabled selected hidden>Select a city</option>
                            {% for val, label in form.city.choices %}
                                <option value="{{ val }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        {{ form.parkingLot.label }}<span class="text-danger">*</span>
                        <select class="form-control" name="{{ form.parkingLot.name }}" id="parking-lot-select" disabled required onchange="parkingLotSelected(this)">
                            <option value="" disabled selected hidden>Please select a city first</option>
                        </select>
                    </div>


      <!-- Start Time -->
<div class="form-group">
    <label for="start-time">Start Time*</label>
                <input type="hidden" id="start-time" name="startTime">

    <div class="input-group">
        <select class="form-control hour-select" name="startHour" required>
            {% for i in range(7, 24) %}
                <option value="{{ i }}">{{ i }}</option>
            {% endfor %}
        </select>
        <select class="form-control minute-select" name="startMinute" required>
            <option value="00">00</option>
            <option value="15">15</option>
            <option value="30">30</option>
            <option value="45">45</option>
        </select>
    </div>
</div>

<!-- End Time -->
<div class="form-group">
    <label for="end-time">End Time*</label>
<input type="hidden" id="end-time" name="endTime">

    <div class="input-group">
        <select class="form-control hour-select" name="endHour" required>
            {% for i in range(7, 24) %}
                <option value="{{ i }}">{{ i }}</option>
            {% endfor %}
        </select>
        <select class="form-control minute-select" name="endMinute" required>
            <option value="00">00</option>
            <option value="15">15</option>
            <option value="30">30</option>
            <option value="45">45</option>
        </select>
    </div>
</div>


                </div>
                <div id="parking-info" class="" style="display:none"></div>



            <button type="submit" class="btn btn-primary" disabled id="submit-button">Submit</button>
            </form>
            <div id="map" style="height: 500px; width: 100%; margin-top: 20px;"></div>
        </div>
        <div class="col-2"></div>
    </div>
</div>

<!-- Add Mapbox GL JS CSS and JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>

<script>
// Mapbox access token
mapboxgl.accessToken = "pk.eyJ1IjoiYWJjZDEyMzQtLSIsImEiOiJjbWNiMGVkdGswODMyMmpzYWVxeXd0OHF2In0.U95wJcVAPpjsoQiRvnXe4Q";

// Initialize the map
var map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/streets-v11",
    center: [33.4299, 35.1264], // Cyprus coordinates [lng, lat]
    zoom: 7
});

// Add navigation controls
map.addControl(new mapboxgl.NavigationControl());


const submitButton = document.getElementById("submit-button");

function validateBookingTime(bool) {
    const startHour = parseInt(document.querySelector('[name="startHour"]').value);
    const startMinute = parseInt(document.querySelector('[name="startMinute"]').value);
    const endHour = parseInt(document.querySelector('[name="endHour"]').value);
    const endMinute = parseInt(document.querySelector('[name="endMinute"]').value);

    // Check if end time is before start time
    if (endHour < startHour || (endHour === startHour && endMinute <= startMinute)) {
        submitButton.disabled = true;
        // Optional: show error message

        if (bool != true){

            if (!document.getElementById("time-error")) {
                const errorDiv = document.createElement("div");
                errorDiv.id = "time-error";
                errorDiv.className = "text-danger mt-2";
                errorDiv.textContent = "End time must be after start time";
                document.querySelector('.form-group:last-child').appendChild(errorDiv);
            }
        }
    } else {
        submitButton.disabled = false;
        const errorDiv = document.getElementById("time-error");
        if (errorDiv) errorDiv.remove();
    }
}

// Add event listeners to time selects
document.querySelectorAll('[name="startHour"], [name="startMinute"], [name="endHour"], [name="endMinute"]').forEach(select => {
    select.addEventListener('change', validateBookingTime);
});

// Modify your form submit handler
document.querySelector('form').addEventListener('submit', function(e) {
    // Combine hour + minute into startTime/endTime fields
    const startHour = document.querySelector('[name="startHour"]').value;
    const startMinute = document.querySelector('[name="startMinute"]').value;
    document.getElementById('start-time').value = `${startHour}:${startMinute}`;

    const endHour = document.querySelector('[name="endHour"]').value;
    const endMinute = document.querySelector('[name="endMinute"]').value;
    document.getElementById('end-time').value = `${endHour}:${endMinute}`;

    // Validate again on submit
    validateBookingTime();

    // Prevent submission if validation fails
    if (submitButton.disabled) {
        e.preventDefault();
    }
});

// Function to handle city selection change
function cityChanged(selectElement) {
    const cityId = selectElement.value;
    const cityName = selectElement.options[selectElement.selectedIndex].text;
    const parkingInfo = document.getElementById("parking-info");

    parkingInfo.style.display = "none"

    // Zoom to the selected city
    zoomToCity(cityName);

    // Fetch parking lots for the selected city
    fetch("/city_selected", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({city: cityId})
    })
    .then(response => response.json())
    .then(data => {
        const parkingSelect = document.getElementById("parking-lot-select");
        parkingSelect.innerHTML = '<option value="" disabled selected hidden>Select a parking lot</option>';

        // Clear previous markers

        data.forEach(lot => {
            const option = document.createElement("option");
            option.value = lot.id;
            option.textContent = lot.name;
            option.dataset.address = lot.address; // Store address for geocoding
            parkingSelect.appendChild(option);
        });

        parkingSelect.disabled = false;
    });
}

// Function to handle parking lot selection
function parkingLotSelected(selectElement) {
    const parkingLotId = selectElement.value;
    const address = selectElement.options[selectElement.selectedIndex].dataset.address;
    const parkingInfo = document.getElementById("parking-info");




    submitButton.disabled = true;



    fetch("/check_parking_capacity", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ parkingLotId: parkingLotId })
        })
        .then(response => response.json())
        .then(data => {
            parkingInfo.style.display = 'block';
            if (data.isFull) {
                parkingInfo.textContent = "No available spots left";
                parkingInfo.className = "text-danger";
                bool = true;
                validateBookingTime(bool);
            } else {
                parkingInfo.textContent = `${data.available} spots available (of ${data.capacity})`;
                parkingInfo.className = "text-success";
                bool = true;
                validateBookingTime(bool);
            }
        });






    // Geocode the address using Mapbox Geocoding API
    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address + ", Cyprus")}.json?access_token=${mapboxgl.accessToken}`)
        .then(response => response.json())
        .then(data => {
            if (data.features && data.features.length > 0) {
                const coordinates = data.features[0].center;

                // Zoom to the location
                map.flyTo({
                    center: coordinates,
                    zoom: 16
                });
            }
        });
}

// Function to zoom to selected city
function zoomToCity(cityName) {
    if (!cityName) return;


    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(`${cityName}, Cyprus`)}.json?access_token=${mapboxgl.accessToken}`)
        .then(response => response.json())
        .then(data => {
            if (data.features && data.features.length > 0) {
                // Find the most relevant result (usually the first one)
                const feature = data.features[0];
                const coordinates = feature.center;

                // Fly to the location with appropriate zoom
                map.flyTo({
                    center: coordinates,
                    zoom: 12, // Good city-level zoom
                    essential: true // This ensures the animation happens
                });


            }

        });
}

// Function to clear all markers

</script>

{% endblock %}
