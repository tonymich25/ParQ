{% extends "base2.html" %}

{% block extra_styles %}
<style>
  .dashboard-header {
    background: linear-gradient(135deg, #4361ee 0%, #4cc9f0 100%);
    color: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
  }

  .dashboard-header::before {
    content: "";
    position: absolute;
    top: -50px;
    right: -50px;
    width: 200px;
    height: 200px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
  }

  .dashboard-title {
    font-weight: 700;
    position: relative;
    z-index: 2;
  }

  .dashboard-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .dashboard-card-header {
    background-color: white;
    border-bottom: 1px solid #e9ecef;
    padding: 1.25rem 1.5rem;
    font-weight: 600;
    border-radius: 12px 12px 0 0 !important;
  }

  .booking-card {
    transition: transform 0.3s ease;
    margin-bottom: 1rem;
  }

  .booking-card:hover {
    transform: translateY(-3px);
  }

  .booking-status {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    border-radius: 50px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .status-active {
    background-color: #d1fae5;
    color: #065f46;
  }

  .status-upcoming {
    background-color: #e0f2fe;
    color: #075985;
  }

  .status-completed {
    background-color: #f3f4f6;
    color: #4b5563;
  }

  .map-mini {
    height: 120px;
    width: 100%;
    border-radius: 8px;
    overflow: hidden;
  }

  .history-item {
    border-left: 3px solid transparent;
    transition: all 0.2s ease;
  }

  .history-item:hover {
    border-left-color: var(--primary-color);
    background-color: #f8f9fa;
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    background-color: #f8f9fa;
    border-radius: 8px;
  }

  .empty-state-icon {
    font-size: 2.5rem;
    color: #adb5bd;
    margin-bottom: 1rem;
  }

  .spot-indicator {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    display: inline-block;
    margin-right: 6px;
  }

  .spot-regular {
    background-color: #4361ee;
  }

  .spot-electric {
    background-color: #4bb543;
  }

  .spot-disabled {
    background-color: #6c757d;
  }

  .spot-premium {
    background-color: #fca311;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="dashboard-title mb-3">Welcome back, {{ current_user.first_name }}!</h1>
        <p class="mb-0">Manage your parking reservations and view history</p>
      </div>
      <div class="col-md-4 text-md-end">
        <a href="{{ url_for('booking.book') }}" class="btn btn-light btn-lg">
          <i class="bi bi-plus-circle"></i> New Booking
        </a>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="row">
    <!-- Left Column - Bookings -->
    <div class="col-lg-7 mb-4">
      <div class="dashboard-card">
        <div class="dashboard-card-header d-flex justify-content-between align-items-center">
          <h3 class="mb-0"><i class="bi bi-car-front-fill text-primary me-2"></i>Your Bookings</h3>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary active">All</button>
            <button class="btn btn-outline-secondary">Active</button>
            <button class="btn btn-outline-secondary">Upcoming</button>
          </div>
        </div>
        <div class="card-body" style="overflow-y: auto;">
          {% if bookings %}
            <div class="list-group list-group-flush">
              {% for booking in bookings %}
              <div class="list-group-item border-0 px-0 py-3">
                <div class="booking-card card">
                  <div class="card-body">
                    <div class="row">
                      <div class="col-8">
                        <div class="d-flex align-items-center mb-2">
                          <span class="booking-status {% if booking.is_active %}status-active{% else %}status-upcoming{% endif %} me-2">
                            {% if booking.is_active %}
                              <i class="bi bi-check-circle-fill me-1"></i> Active
                            {% else %}
                              <i class="bi bi-clock-fill me-1"></i> Upcoming
                            {% endif %}
                          </span>
                          <small class="text-muted">#{{ booking.id }}</small>
                        </div>
                        <h5 class="mb-2">{{ booking.parking_lot.name }}</h5>
                        <p class="text-muted mb-2"><i class="bi bi-geo-alt-fill me-1"></i>{{ booking.parking_lot.address }}</p>

                        <div class="d-flex text-muted mb-2">
                          <div class="me-3">
                            <i class="bi bi-calendar-event me-1"></i>
                            <span>{{ booking.booking_date.strftime('%b %d') }}</span>
                          </div>
                          <div>
                            <i class="bi bi-clock me-1"></i>
                            <span>{{ booking.start_time.strftime('%I:%M %p') }} - {{ booking.end_time.strftime('%I:%M %p') }}</span>
                          </div>
                        </div>

                        <div class="d-flex align-items-center">
                          <span class="spot-indicator spot-{{ booking.spot_type|lower }}"></span>
                          <span>Spot #{{ booking.spot_id }} ({{ booking.spot_type }})</span>
                        </div>
                      </div>
                      <div class="col-4">
                        <div class="map-mini" id="map-{{ booking.id }}"></div>
                        <div class="mt-2 text-end">
                          <a href="#" class="btn btn-sm btn-outline-primary">Details</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state">
              <div class="empty-state-icon">
                <i class="bi bi-calendar-x"></i>
              </div>
              <h4 class="mb-3">No Upcoming Bookings</h4>
              <p class="text-muted mb-4">You don't have any active or upcoming parking reservations</p>
              <a href="{{ url_for('booking.book') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Book Your First Spot
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right Column - History and Quick Actions -->
    <div class="col-lg-5 mb-4">
      <!-- Quick Actions Card -->
      <div class="card mb-4">
        <div class="dashboard-card-header">
          <h3 class="mb-0"><i class="bi bi-lightning-charge text-primary me-2"></i>Quick Actions</h3>
        </div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-6">
              <a href="{{ url_for('booking.book') }}" class="btn btn-outline-primary w-100 py-3">
                <i class="bi bi-plus-circle d-block mb-1" style="font-size: 1.5rem;"></i>
                New Booking
              </a>
            </div>
            <div class="col-6">
              <a href="#" class="btn btn-outline-secondary w-100 py-3">
                <i class="bi bi-qr-code d-block mb-1" style="font-size: 1.5rem;"></i>
                Scan QR
              </a>
            </div>
            <div class="col-6">
              <a href="#" class="btn btn-outline-secondary w-100 py-3">
                <i class="bi bi-credit-card d-block mb-1" style="font-size: 1.5rem;"></i>
                Payment
              </a>
            </div>
            <div class="col-6">
              <a href="#" class="btn btn-outline-secondary w-100 py-3">
                <i class="bi bi-gear d-block mb-1" style="font-size: 1.5rem;"></i>
                Settings
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- History Card -->
      <div class="dashboard-card">
        <div class="dashboard-card-header">
          <h3 class="mb-0"><i class="bi bi-clock-history text-primary me-2"></i>Recent History</h3>
        </div>
        <div class="card-body" style="overflow-y: auto;">
          {% if history %}
            <div class="list-group list-group-flush">
              {% for item in history %}
              <a href="#" class="list-group-item list-group-item-action history-item py-3">
                <div class="d-flex justify-content-between">
                  <div>
                    <h6 class="mb-1">{{ item.location }}</h6>
                    <small class="text-muted">{{ item.date }} â€¢ {{ item.duration }}</small>
                  </div>
                  <div class="text-end">
                    <span class="d-block text-dark">${{ item.price }}</span>
                    <span class="badge bg-light text-dark rounded-pill">{{ item.status }}</span>
                  </div>
                </div>
              </a>
              {% endfor %}
            </div>
            <div class="text-center mt-3">
              <a href="#" class="btn btn-sm btn-outline-primary">View All History</a>
            </div>
          {% else %}
            <div class="empty-state">
              <div class="empty-state-icon">
                <i class="bi bi-clock-history"></i>
              </div>
              <h4 class="mb-3">No History Yet</h4>
              <p class="text-muted">Your parking history will appear here</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mapbox JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
<script>
  // Initialize maps for each booking
  mapboxgl.accessToken = "pk.eyJ1IjoiYWJjZDEyMzQtLSIsImEiOiJjbWNiMGVkdGswODMyMmpzYWVxeXd0OHF2In0.U95wJcVAPpjsoQiRvnXe4Q";

  document.addEventListener('DOMContentLoaded', function() {
    {% if bookings %}
      {% for booking in bookings %}
        // Initialize map for booking {{ booking.id }}
        const map{{ booking.id }} = new mapboxgl.Map({
          container: 'map-{{ booking.id }}',
          style: 'mapbox://styles/mapbox/streets-v11',
          center: [{{ booking.parking_lot.longitude }}, {{ booking.parking_lot.latitude }}],
          zoom: 15,
          interactive: false
        });

        // Add marker
        new mapboxgl.Marker({ color: '#4361ee' })
          .setLngLat([{{ booking.parking_lot.longitude }}, {{ booking.parking_lot.latitude }}])
          .addTo(map{{ booking.id }});
      {% endfor %}
    {% endif %}
  });
</script>
{% endblock %}